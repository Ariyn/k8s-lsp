name: Release Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build_server:
    name: Build Server (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: x64
            goos: linux
            goarch: amd64
          - os: darwin
            arch: x64
            goos: darwin
            goarch: amd64
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
          - os: windows
            arch: x64
            goos: windows
            goarch: amd64

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Build Binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        mkdir -p output
        go build -o output/k8s-lsp${{ matrix.os == 'windows' && '.exe' || '' }} .
        # Ensure executable bit is set for Unix targets (artifacts/packaging can drop mode bits).
        if [ "${{ matrix.os }}" != "windows" ]; then chmod +x output/k8s-lsp; fi
        mkdir -p output/rules
        cp rules/k8s.yaml output/rules/
        cp rules/validation.yaml output/rules/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: server-binaries-${{ matrix.os }}-${{ matrix.arch }}
        path: output/

  package:
    needs: build_server
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install vsce
      run: npm install -g @vscode/vsce

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: bin-temp

    - name: Prepare and Package
      run: |
        # Create build directory
        mkdir -p build
        
        # Copy client source
        cp -r client/. build/
        
        # Create bin directory
        mkdir -p build/bin
        
        # Copy binaries from artifacts
        mkdir -p build/bin/linux/x64
        cp -r bin-temp/server-binaries-linux-x64/* build/bin/linux/x64/
        
        mkdir -p build/bin/darwin/x64
        cp -r bin-temp/server-binaries-darwin-x64/* build/bin/darwin/x64/
        
        mkdir -p build/bin/darwin/arm64
        cp -r bin-temp/server-binaries-darwin-arm64/* build/bin/darwin/arm64/
        
        mkdir -p build/bin/windows/x64
        cp -r bin-temp/server-binaries-windows-x64/* build/bin/windows/x64/
        
        # Verify structure
        ls -R build/bin

        # Ensure packaged server binaries are executable on Unix platforms
        chmod -R a+rX build/bin
        if [ -f build/bin/linux/x64/k8s-lsp ]; then chmod +x build/bin/linux/x64/k8s-lsp; fi
        if [ -f build/bin/darwin/x64/k8s-lsp ]; then chmod +x build/bin/darwin/x64/k8s-lsp; fi
        if [ -f build/bin/darwin/arm64/k8s-lsp ]; then chmod +x build/bin/darwin/arm64/k8s-lsp; fi
        
        # Build extension
        cd build
        npm install
        npm run compile
        
        # Package
        vsce package -o ../k8s-lsp-client.vsix

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: k8s-lsp-client.vsix
        generate_release_notes: true
