rules:
  - kind: "Service"
    checks:
      - type: "reference"
        path: "spec.selector"
        targetKind: "Deployment"
        targetPath: "spec.template.metadata.labels"
        message: "No Deployment found matching this selector"

  - kind: "Ingress"
    checks:
      - type: "reference"
        path: "spec.rules[*].http.paths[*].backend.service.name"
        targetKind: "Service"
        targetPath: "metadata.name"
        message: "Service not found"

  - kind: "Deployment"
    checks:
      - type: "reference"
        path: "spec.template.spec.serviceAccountName"
        targetKind: "ServiceAccount"
        targetPath: "metadata.name"
        message: "ServiceAccount not found"
      - type: "reference"
        path: "spec.template.spec.containers[*].envFrom[*].configMapRef.name"
        targetKind: "ConfigMap"
        targetPath: "metadata.name"
        message: "ConfigMap not found"
      - type: "reference"
        path: "spec.template.spec.containers[*].envFrom[*].secretRef.name"
        targetKind: "Secret"
        targetPath: "metadata.name"
        message: "Secret not found"
      - type: "reference"
        path: "spec.template.spec.volumes[*].persistentVolumeClaim.claimName"
        targetKind: "PersistentVolumeClaim"
        targetPath: "metadata.name"
        message: "PersistentVolumeClaim not found"

  - kind: "PersistentVolumeClaim"
    checks:
      - type: "reference"
        path: "spec.storageClassName"
        targetKind: "StorageClass"
        targetPath: "metadata.name"
        message: "StorageClass not found"
      - type: "resource-match"
        path: "spec.volumeName"
        targetKind: "PersistentVolume"
        targetPath: "metadata.name"
        sourceProperty: "spec.resources.requests.storage"
        targetProperty: "spec.capacity.storage"
        message: "Storage capacity mismatch"
      - type: "resource-match"
        path: "spec.volumeName"
        targetKind: "PersistentVolume"
        targetPath: "metadata.name"
        sourceProperty: "spec.accessModes"
        targetProperty: "spec.accessModes"
        message: "Access modes mismatch"

  - kind: "NetworkPolicy"
    checks:
      - type: "reference"
        path: "spec.podSelector"
        targetKind: "Deployment"
        targetPath: "spec.template.metadata.labels"
        message: "No Deployment found matching this selector"
